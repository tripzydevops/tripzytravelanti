
// =====================================================
// PROMO CODE OPERATIONS
// =====================================================

export interface PromoCode {
    code: string;
    discountType: 'percentage' | 'fixed_amount';
    discountValue: number;
    maxUses?: number;
    currentUses: number;
    expiresAt?: string;
    isActive: boolean;
    createdAt: string;
}

export async function getPromoCodes(): Promise<PromoCode[]> {
    const { data, error } = await supabase
        .from('promo_codes')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error fetching promo codes:', error);
        return [];
    }

    return data.map((pc: any) => ({
        code: pc.code,
        discountType: pc.discount_type,
        discountValue: pc.discount_value,
        maxUses: pc.max_uses,
        currentUses: pc.current_uses,
        expiresAt: pc.expires_at,
        isActive: pc.is_active,
        createdAt: pc.created_at
    }));
}

export async function createPromoCode(promoCode: Omit<PromoCode, 'currentUses' | 'createdAt'>) {
    const dbPromo = {
        code: promoCode.code,
        discount_type: promoCode.discountType,
        discount_value: promoCode.discountValue,
        max_uses: promoCode.maxUses,
        expires_at: promoCode.expiresAt,
        is_active: promoCode.isActive
    };

    const { data, error } = await supabase
        .from('promo_codes')
        .insert(dbPromo)
        .select()
        .single();

    if (error) {
        console.error('Error creating promo code:', error);
        throw error;
    }

    return data;
}

export async function togglePromoCodeStatus(code: string, isActive: boolean) {
    const { error } = await supabase
        .from('promo_codes')
        .update({ is_active: isActive })
        .eq('code', code);

    if (error) {
        console.error('Error updating promo code status:', error);
        throw error;
    }
}

export async function deletePromoCode(code: string) {
    const { error } = await supabase
        .from('promo_codes')
        .delete()
        .eq('code', code);

    if (error) {
        console.error('Error deleting promo code:', error);
        throw error;
    }
}

export async function verifyPromoCode(code: string): Promise<{ valid: boolean; message: string; code?: string; discountType?: 'percentage' | 'fixed_amount'; discountValue?: number }> {
    const { data, error } = await supabase.rpc('verify_promo_code', { code_input: code });

    if (error) {
        console.error('Error verifying promo code:', error);
        return { valid: false, message: 'Verification failed' };
    }

    return {
        valid: data.valid,
        message: data.message,
        code: data.code,
        discountType: data.discount_type,
        discountValue: data.discount_value
    };
}

export async function applyPromoCode(code: string, txnId?: string): Promise<boolean> {
    const { data, error } = await supabase.rpc('apply_promo_code', { code_input: code, txn_id: txnId });

    if (error) {
        console.error('Error applying promo code:', error);
        return false;
    }

    return data;
}
